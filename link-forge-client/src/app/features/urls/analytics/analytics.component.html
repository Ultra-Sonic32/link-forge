<div class="dashboard-wrapper">
  <!-- Loading -->
  <div class="d-flex justify-content-center mb-3" *ngIf="isLoadingData()">
    <div class="spinner-border text-light" role="status">
      <span class="ms-2 mt-1 text-white">Loading data data...</span>
    </div>
  </div>

  <!--Dashboard statst Cards-->
  <div class="dashboard-container">
    <div class="card-grid">
      <div class="dashboard-card">
        <h5 class="card-header">Total Short URLs</h5>
        <div class="card-body">
          <h5 class="card-title">{{ totalUrls() }}</h5>
        </div>
      </div>

      <div class="dashboard-card">
        <h5 class="card-header">Total Clicks</h5>
        <div class="card-body">
          <h5 class="card-title">{{ totalClicks() }}</h5>
        </div>
      </div>

      <div class="dashboard-card">
        <h5 class="card-header">Most Clicked</h5>
        <div class="card-body">
          <h5 class="card-title">
            <a
              [href]="'http://localhost:3000/urls/resolve/' + mostClicked()"
              target="_blank"
              class="card-link"
              >{{ mostClicked() }}</a
            >
          </h5>
        </div>
      </div>

      <div class="dashboard-card">
        <h5 class="card-header">Latest URL</h5>
        <div class="card-body">
          <h5 class="card-title">
            <a
              [href]="'http://localhost:3000/urls/resolve/' + mostRecent()"
              target="_blank"
              class="card-link"
              >{{ mostRecent() }}</a
            >
          </h5>
        </div>
      </div>
    </div>
  </div>
  <!--Click over Time-->
  <div class="chart-container">
    <canvas id="clicksLineChart"></canvas>
  </div>

  <!--Table Tabs-->
  <ul class="nav nav-tabs nav-custom-tabs justify-content-left mb-4">
    <li class="nav-item">
      <button
        class="nav-link"
        [ngClass]="{ active: selectedTab() === 'urls' }"
        (click)="selectedTab.set('urls')"
      >
        Top 5 URLs
      </button>
    </li>
    <li class="nav-item">
      <button
        class="nav-link"
        [ngClass]="{ active: selectedTab() === 'analytics' }"
        (click)="selectedTab.set('analytics')"
      >
        Activity Logs
      </button>
    </li>
  </ul>

  <!--Top 5 urls table-->

  <div class="table-container" *ngIf="selectedTab() === 'urls'">
    <div class="view-box">
      <h2 class="text-center text-white mb-4">Top 5 Urls</h2>
      <div *ngIf="!isLoadingData()">
        <!-- Table -->
        <div class="table-responsive view-table">
          <table class="table table-striped table-bordered text-center align-middle">
            <thead class="table-dark text-nowrap">
              <tr>
                <th>#</th>
                <th>Original URL</th>
                <th>Short URL</th>
                <th>Click</th>
                <th>Last Accessed</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let url of paginatedUrls(); let i = index">
                <td>{{ i + 1 }}</td>

                <td class="text-truncate" style="max-width: 200px" [title]="url.originalUrl">
                  {{ url.originalUrl }}
                </td>

                <td>
                  <a [href]="'http://localhost:3000/urls/resolve/' + url.shortUrl" target="_blank">
                    {{ url.shortUrl }}
                  </a>
                </td>
                <td>{{ url.clicks }}</td>

                <td>{{ url.lastAccessed | date : "yyyy/mm/dd 'at' hh:mm" }}</td>
                <td>
                  <span class="badge" [ngClass]="url.isActive ? 'bg-success' : 'bg-danger'">
                    {{ url.isActive ? 'Active' : 'Inactive' }}
                  </span>
                </td>

                <td>
                  <button
                    style="color: black"
                    class="btn btn-sm"
                    (click)="copyShortUrl(url.shortUrl)"
                  >
                    <i class="fas fa-copy"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <app-pagination
          [currentPage]="topUrlsCurrentPage()"
          [itemsPerPage]="topUrlsItemsPerPage()"
          [totalItems]="topUrls().length"
          (pageChange)="goToTopUrlsPage($event)"
          (itemsPerPageChange)="onTopUrlsItemsPerPageChange($event)"
        ></app-pagination>

        <!-- No Results -->
        <div *ngIf="topUrls().length === 0" class="text-center mt-3 text-white">
          <p>No URLs found.</p>
        </div>
      </div>
    </div>
  </div>

  <!--analytics table-->
  <div class="table-container" *ngIf="selectedTab() === 'analytics'">
    <div class="view-box">
      <h2 class="text-center text-white mb-4">Recent Analytic Logs</h2>
      <div *ngIf="!isLoadingData()">
        <!-- Table -->
        <div class="table-responsive view-table">
          <table class="table table-striped table-bordered text-center align-middle">
            <thead class="table-dark text-nowrap">
              <tr>
                <th>#</th>
                <th>Short URL</th>
                <th>Date Accessed</th>
                <th>User Agent</th>
                <th>Referrer</th>
                <th>Browser</th>
                <th>OS</th>
                <th>Device</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let analytics of paginatedAnalytics(); let i = index">
                <td>{{ i + 1 }}</td>
                <td>
                  <a
                    [href]="'http://localhost:3000/urls/resolve/' + analytics.shortUrl"
                    target="_blank"
                  >
                    {{ analytics.shortUrl }}
                  </a>
                </td>
                <td>{{ analytics.accessedAt | date : "yyyy/mm/dd 'at' hh:mm" }}</td>
                <td>{{ analytics.userAgent }}</td>
                <td>{{ analytics.referrer }}</td>
                <td>{{ analytics.browser }}</td>
                <td>{{ analytics.os }}</td>
                <td>{{ analytics.device }}</td>
                <td>
                  <div style="display: flex; gap: 0.5rem; justify-content: center">
                    <button
                      class="btn btn-sm"
                      style="color: black"
                      (click)="copyShortUrl(analytics.shortUrl)"
                    >
                      <i class="fas fa-copy"></i>
                    </button>
                    <button
                      class="btn btn-sm"
                      style="color: black"
                      (click)="detailedInfoModal(analytics)"
                    >
                      <i class="fas fa-info-circle"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <app-pagination
          [currentPage]="analyticsCurrentPage()"
          [itemsPerPage]="analyticsItemsPerPage()"
          [totalItems]="recentAccessLogs().length"
          (pageChange)="goToAnalyticsPage($event)"
          (itemsPerPageChange)="onAnalyticsItemsPerPageChange($event)"
        ></app-pagination>

        <!-- No Results -->
        <div *ngIf="recentAccessLogs().length === 0" class="text-center mt-3 text-white">
          <p>No logs found.</p>
        </div>
      </div>
    </div>
  </div>

  <app-analytics-details-modal
    [log]="selectedLog()"
    [show]="showDetailsModal()"
    (click)="closeModal()"
  ></app-analytics-details-modal>
</div>
